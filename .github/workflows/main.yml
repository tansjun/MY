name: Daily Update

on:
  schedule:
    # 仅在23:00触发1次任务
    - cron: '0 23 * * *'  
  workflow_dispatch:
    branches:
      - main
 
jobs:
  run_script:
    runs-on: ubuntu-latest
    # 核心：定义延迟范围参数（可直接修改这里的数值）
    env:
      TZ: Asia/Shanghai
      PLAYWRIGHT_HEADLESS: "1"
      # 自定义延迟范围（单位：秒）
      MIN_DELAY_SECONDS: 1       # 0.1分钟 = 6秒（最小延迟）
      MAX_DELAY_SECONDS: 3    # 30分钟 = 1800秒（最大延迟）

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install system dependencies (for Playwright)
      run: |
        sudo apt-get update && sudo apt-get install -y \
          libnss3 libatk-bridge2.0-0 libdrm-dev libxkbcommon-dev libgbm-dev \
          libasound2 libatspi2.0-0 libxshmfence-dev
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 playwright
        playwright install chromium --with-deps

    - name: Generate custom random delay (0.1~30 minutes)
      if: github.event_name == 'schedule'
      id: generate_delay
      run: |
        # 读取自定义的最小/最大延迟（从环境变量）
        MIN_DELAY=${{ env.MIN_DELAY_SECONDS }}
        MAX_DELAY=${{ env.MAX_DELAY_SECONDS }}
        
        # 生成 MIN_DELAY ~ MAX_DELAY 之间的随机数（秒）
        # 公式：$((MIN + RANDOM % (MAX - MIN + 1)))
        RANDOM_DELAY=$((MIN_DELAY + RANDOM % (MAX_DELAY - MIN_DELAY + 1)))
        
        # 转换为分钟+秒，便于日志展示
        DELAY_MINUTES=$((RANDOM_DELAY / 60))
        DELAY_SECONDS=$((RANDOM_DELAY % 60))
        
        # 输出日志
        echo "✅ 自定义延迟范围：${MIN_DELAY}秒(${MIN_DELAY}/60分钟) ~ ${MAX_DELAY}秒(${MAX_DELAY}/60分钟)"
        echo "✅ 本次随机延迟：${DELAY_MINUTES} 分 ${DELAY_SECONDS} 秒（总计 ${RANDOM_DELAY} 秒）"
        
        # 传递到后续步骤
        echo "random_delay=$RANDOM_DELAY" >> $GITHUB_OUTPUT

    - name: Execute random delay
      if: github.event_name == 'schedule'
      run: |
        sleep ${{ steps.generate_delay.outputs.random_delay }}

    - name: Run Python script
      run: python main.py

    - name: Commit and push if changed
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        if ! git diff --staged --quiet; then
          git commit -m "Auto-update live files $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
