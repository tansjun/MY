name: Daily Update

on:
  schedule:
    # 仅在23:00触发1次任务
    - cron: '0 23 * * *'  
  workflow_dispatch:
    branches:
      - main
 
jobs:
  run_script:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      PLAYWRIGHT_HEADLESS: "1"
      # 自定义延迟范围（单位：秒）
      MIN_DELAY_SECONDS: 1       # 0.1分钟 = 6秒（最小延迟）
      MAX_DELAY_SECONDS: 3    # 30分钟 = 1800秒（最大延迟）

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies (适配Ubuntu 22.04+)
      run: |
        sudo apt-get update -y
        # 关键修正：所有依赖包写在同一行，避免shell换行语法错误
        sudo apt-get install -y --no-install-recommends libnss3 libatk-bridge2.0-0 libdrm-dev libxkbcommon-dev libgbm-dev libatspi2.0-0 libxshmfence-dev libasound2t64 libgtk-3-0 libx11-xcb1 libxcb-dri3-0 libxrandr2 libxcursor1 libxcomposite1 libasound2-plugins libpulse0
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 playwright
        # 强制安装适配的Chromium版本，避免版本不兼容
        playwright install chromium --with-deps --force

    - name: Generate custom random delay (0.1~30 minutes)
      if: github.event_name == 'schedule'
      id: generate_delay
      run: |
        MIN_DELAY=${{ env.MIN_DELAY_SECONDS }}
        MAX_DELAY=${{ env.MAX_DELAY_SECONDS }}
        RANDOM_DELAY=$((MIN_DELAY + RANDOM % (MAX_DELAY - MIN_DELAY + 1)))
        DELAY_MINUTES=$((RANDOM_DELAY / 60))
        DELAY_SECONDS=$((RANDOM_DELAY % 60))
        echo "✅ 自定义延迟范围：${MIN_DELAY}秒 ~ ${MAX_DELAY}秒"
        echo "✅ 本次随机延迟：${DELAY_MINUTES} 分 ${DELAY_SECONDS} 秒（总计 ${RANDOM_DELAY} 秒）"
        echo "random_delay=$RANDOM_DELAY" >> $GITHUB_OUTPUT

    - name: Execute random delay
      if: github.event_name == 'schedule'
      run: |
        sleep ${{ steps.generate_delay.outputs.random_delay }}

    - name: Run Python script
      run: python main.py

    - name: Commit and push if changed
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        if ! git diff --staged --quiet; then
          git commit -m "Auto-update live files $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
